<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at Apr 1, 2013
 | Rendered using Apache Maven Fluido Skin 1.2.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>maestro-plugin - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

    
    <meta name="Date-Revision-yyyymmdd" content="20130401" />
    <meta http-equiv="Content-Language" content="en" />
    
        </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>maestro-plugin</h2>
                </div>
                      </div>
        <div class="pull-right">                  <a href="http://www.maestrodev.com/" id="bannerRight">
                                                                                        <img src="http://www.maestrodev.com/wp-content/themes/maestrodev/images/logo.png"  alt="MaestroDev"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="projectVersion">Version: 2.0-SNAPSHOT</li>
              
                
            
                  <li id="publishDate" class="pull-right">Last Published: 01 Apr 2013</li> 
            
                  </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
            
                                    <h3>Overview</h3>
                  <ul>
                  <li class="none">
            <strong>Introduction</strong>
          </li>
          </ul>
                        <h3>Project Documentation</h3>
                  <ul>
                                                                                                                                                                                                                                                                  <li class="expanded">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                    <ul>
                      <li class="none">
            <strong>About</strong>
          </li>
                      <li class="none">
                          <a href="project-summary.html" title="Project Summary">Project Summary</a>
            </li>
                      <li class="none">
                          <a href="license.html" title="Project License">Project License</a>
            </li>
                      <li class="none">
                          <a href="team-list.html" title="Project Team">Project Team</a>
            </li>
                      <li class="none">
                          <a href="source-repository.html" title="Source Repository">Source Repository</a>
            </li>
                      <li class="none">
                          <a href="issue-tracking.html" title="Issue Tracking">Issue Tracking</a>
            </li>
                      <li class="none">
                          <a href="dependency-management.html" title="Dependency Management">Dependency Management</a>
            </li>
                      <li class="none">
                          <a href="dependencies.html" title="Dependencies">Dependencies</a>
            </li>
                      <li class="none">
                          <a href="plugin-management.html" title="Plugin Management">Plugin Management</a>
            </li>
                      <li class="none">
                          <a href="plugins.html" title="Project Plugins">Project Plugins</a>
            </li>
                      <li class="none">
                          <a href="distribution-management.html" title="Distribution Management">Distribution Management</a>
            </li>
              </ul>
        </li>
                                                                                                                          <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                      
            
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Maestro Plugin</h1><p>Maestro 4 provides support for plugins written in Java and Ruby. They are both permitted to have dependent libraries. Ruby based plugins provide the worker source file (.rb) and any dependencies (.gem) are loaded using the Rubygems (gem) executable. Java based plugins provide a java package (.jar) containing worker source, a project object model (pom.xml) with a list of dependencies. Java dependencies are then loaded using Maven. Both plugin types provide a manifest file (manifest.json) that details the contents and attributes of the plugin.</p><div class="section"><h2>Develop a Maestro 4 plugin<a name="Develop_a_Maestro_4_plugin"></a></h2><p>This is a simple example that shows how to create an IRC plugin in Java. The example uses netbeans for code editing and to add dependencies.</p><div class="section"><h3>Create a Maven Java Application Project<a name="Create_a_Maven_Java_Application_Project"></a></h3><p>The first step is to create a Maven Java Application Project using Netbeans. Select New Project from the File menu. Then Choose Maven - Java Application.</p><p>Enter your project Information, in this case the project is maestro-irc-plugin, set the location to create the project, and the maven project attributes.</p><p>This will create a file structure skeleton. You can rename the templated Source and Test files to IrcWorker and IrcWorkerTest. The pom.xml and settings.xml file are created similarly.</p></div><div class="section"><h3>Adding Dependencies<a name="Adding_Dependencies"></a></h3><p>A Maestro 4 project needs to include the maestro-plugin project and any other dependency in its pom.xml file. In this case we are using the irclib library for Irc functionality. The irclib library has several dependencies of its own as well.</p><div class="section"><h4>pom.xml<a name="pom.xml"></a></h4>
<div class="source"><pre class="prettyprint">  &lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.maestrodev&lt;/groupId&gt;
    &lt;artifactId&gt;maestro-irc-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;

    &lt;name&gt;maestro-irc-plugin&lt;/name&gt;
    &lt;url&gt;http://maven.apache.org&lt;/url&gt;

    &lt;properties&gt;
      &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;3.8.1&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.schwering&lt;/groupId&gt;
        &lt;artifactId&gt;irclib&lt;/artifactId&gt;
        &lt;version&gt;1.10&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;com.maestrodev&lt;/groupId&gt;
        &lt;artifactId&gt;maestro-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;org.mockito&lt;/groupId&gt;
        &lt;artifactId&gt;mockito-all&lt;/artifactId&gt;
        &lt;version&gt;1.9.0&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
      &lt;/dependency&gt;
    &lt;/dependencies&gt;
  &lt;/project&gt;
</pre></div></div></div><div class="section"><h3>Creating the Worker<a name="Creating_the_Worker"></a></h3><p>The source consists of the IrcWorker class and the IrcEventListener class which, as you can tell by the name, is required by the irclib for IRC event handling. The Worker suffix on the class name is convention and not required.</p><div class="section"><h4>IrcWorker<a name="IrcWorker"></a></h4>
<div class="source"><pre class="prettyprint">  package com.maestrodev;

  import org.schwering.irc.lib.IRCConnection;

  /**
   * Hello world!
   *
   */
  public class IrcWorker extends MaestroWorker
  {
      public IrcWorker(){     
          super();
      }
    
      public void postMessage() throws Exception {
        
          final IRCConnection conn = new IRCConnection(
                                      getField(&quot;server&quot;), 
                                      Integer.parseInt(getField(&quot;port&quot;).toString()),
                                      Integer.parseInt(getField(&quot;port&quot;).toString()) + 1, 
                                      null, 
                                      getField(&quot;nickname&quot;), 
                                      getField(&quot;nickname&quot;), 
                                      getField(&quot;nickname&quot;)
                                    ); 
           IrcEventListener eventListener = new IrcEventListener(conn, getField(&quot;channel&quot;), getField(&quot;body&quot;));
           conn.addIRCEventListener(eventListener);
           conn.setDaemon(true);
           conn.setColors(false); 
           conn.setPong(true); 
         
           try {
             conn.connect(); // Try to connect!!! Don't forget this!!!
           } catch (Exception ioexc) {
             ioexc.printStackTrace(); 
           }

         
           while(!eventListener.wasMessageSent()){         
              Thread.sleep(1000);
           }
         
           writeOutput(&quot;The Message Was Sent!&quot;);
         
           conn.close();
      }    
  }
</pre></div><p>IrcWorker is a simple pojo with a method called postMessage. The method postMessage creates a new IRCConnection object with field values provided (I will explain how to define those in a bit). The getField method is used to access value inside the current compositions run context. The connection is created, connected and the method waits for the message to be sent. A call to writeOutput will put the message The Message Was Sent! into the composition runs output stream and stored for access. Finally the connection to the irc server is closed.</p></div><div class="section"><h4>IrcEventListener<a name="IrcEventListener"></a></h4>
<div class="source"><pre class="prettyprint">    /*
    * To change this template, choose Tools | Templates
    * and open the template in the editor.
    */
    package com.maestrodev;

    import org.schwering.irc.lib.IRCConnection;
    import org.schwering.irc.lib.IRCEventListener;
    import org.schwering.irc.lib.IRCModeParser;
    import org.schwering.irc.lib.IRCUser;

    class IrcEventListener implements IRCEventListener {

    
        private IRCConnection connection;
        private boolean messageSent;
        private String body, channel;
    
    
        public IrcEventListener(IRCConnection connection, String channel, String body){
            this.connection = connection;
            this.body = body;
            this.channel = channel;
        }
        
        public synchronized boolean wasMessageSent(){
            return messageSent;
        }
    
        public void onRegistered() {
            connection.doJoin(channel);
            messageSent = false;
        }

        public void onJoin(String string, IRCUser ircu) {
            connection.doPrivmsg(channel, body);
            messageSent = true;
        }

        public void onDisconnected() {
        
        }

        public void onError(String string) {
        
        }

        public void onError(int i, String string) {
        
        }

        public void onInvite(String string, IRCUser ircu, String string1) {
        
        }

        public void onKick(String string, IRCUser ircu, String string1, String string2) {
       
        }

        public void onMode(String string, IRCUser ircu, IRCModeParser ircmp) {
       
        }

        public void onMode(IRCUser ircu, String string, String string1) {
       
        }

        public void onNick(IRCUser ircu, String string) {
       
        }

        public void onNotice(String string, IRCUser ircu, String string1) {
       
        }

        public void onPart(String string, IRCUser ircu, String string1) {
       
        }

        public void onPing(String string) {
       
        }

        public void onPrivmsg(String string, IRCUser ircu, String string1) {
       
        }

        public void onQuit(IRCUser ircu, String string) {
       
        }

        public void onReply(int i, String string, String string1) {
       
        }

        public void onTopic(String string, IRCUser ircu, String string1) {
       
        }

        public void unknown(String string, String string1, String string2, String string3) {
       
        }
    
    }
</pre></div><p>The IrcEventListener is a class for handling irc events the constructor takes the connection, channel, and body objects. The class has a messageSent state variable that allows for monitoring if the message has been sent. The onRegister message is called when the Irc connection is complete. The method then joins the supplied channel. onJoin is called after the join event completes. Finally the message is sent to the channel with body.</p></div><div class="section"><h4>IrcWorkerTest<a name="IrcWorkerTest"></a></h4>
<div class="source"><pre class="prettyprint">package com.maestrodev;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.HashMap;
import junit.framework.Test;
import junit.framework.TestCase;
import junit.framework.TestSuite;
import org.json.simple.JSONObject;

/**
 * Unit test for simple App.
 */
public class IrcWorkerTest 
    extends TestCase
{
    /**
     * Create the test case
     *
     * @param testName name of the test case
     */
    public IrcWorkerTest( String testName )
    {
        super( testName );
    }

    /**
     * @return the suite of tests being tested
     */
    public static Test suite()
    {
        return new TestSuite( IrcWorkerTest.class );
    }
    
    /**
     * Test IrcWorker
     */
    public void testIrcWorker() throws NoSuchMethodException, IllegalAccessException, IllegalArgumentException, InvocationTargetException
    {
        IrcWorker ircWorker = new IrcWorker();
        JSONObject fields = new JSONObject();
        fields.put(&quot;body&quot;, &quot;Hello From Maestro 4!&quot;);
        fields.put(&quot;nickname&quot;, &quot;irc-plugin-test&quot;);        
        fields.put(&quot;server&quot;, &quot;irc.freenode.net&quot;);
        fields.put(&quot;password&quot;, null);
        fields.put(&quot;ssl&quot;, &quot;false&quot;);
        fields.put(&quot;port&quot;, &quot;6667&quot;);
        fields.put(&quot;channel&quot;, &quot;#kittest&quot;);        
        
        JSONObject workitem = new JSONObject();
        workitem.put(&quot;fields&quot;, fields);
        ircWorker.setWorkitem(workitem);
               
        
        Method method = ircWorker.getClass().getMethod(&quot;postMessage&quot;);
        method.invoke(ircWorker);
        
    }
}



</pre></div><p>The testIrcWorker method has a simple example of how the worker will be used when it is install in Maestro 4. The fields are set and the method postMessage is called. This will result in the message Hello From Maestro 4! getting posted in the #kittest channel on irc.freenode.net.</p></div></div><div class="section"><h3>Defining the Manifest<a name="Defining_the_Manifest"></a></h3><div class="section"><h4>manifest.json<a name="manifest.json"></a></h4>
<div class="source"><pre class="prettyprint">[{ 
  &quot;name&quot; : &quot;irc (java)&quot;,
  &quot;description&quot; : &quot;IRC Client Logging Written In Java&quot;,
  &quot;author&quot;: &quot;Kit Plummer&quot;,
  &quot;version&quot;: &quot;1.0&quot;,
  &quot;class&quot;: &quot;com.maestrodev.IrcWorker&quot;,
  &quot;type&quot;:&quot;java&quot;,
  &quot;dependencies&quot;:[
  	{
		  &quot;name&quot;:&quot;maestro-irc-plugin-1.0-SNAPSHOT.jar&quot;
	  },
    {
      &quot;name&quot;:&quot;pom.xml&quot;
    }
  ],
  &quot;task&quot;:{
    &quot;command&quot; : &quot;/irc/postMessage&quot;,    
    &quot;inputs&quot; : {&quot;body&quot; : {&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;String&quot;, &quot;required&quot; : true},
		&quot;nickname&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;String&quot;, &quot;required&quot; : true},
		&quot;server&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;String&quot;, &quot;required&quot; : true},
		&quot;password&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;Password&quot;, &quot;required&quot; : false},
		&quot;ssl&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;Boolean&quot;, &quot;required&quot; : true},
		&quot;port&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;Integer&quot;, &quot;required&quot; : true},
		&quot;channel&quot;:{&quot;value&quot; : &quot;&quot;, &quot;type&quot; : &quot;String&quot;, &quot;required&quot; : true}															
	},
    &quot;outputs&quot; : {},
    &quot;tool_name&quot;:&quot;Notification&quot;
  }
}]

</pre></div><p>Note that the json object is an array of hash objects, this allows you to include more than one method endpoint inside a manifest for a plugin package.</p>
<ul>
  <li>name - Name of the plugin, that is display in the Maestro 4 UI</li>
  <li>description - Description of the plugin that is displayed</li>
  <li>author - Person responsible for such genius</li>
  <li>version - plugins version</li>
  <li>class - The class name of the plugins source worker</li>
  <li>type - java or ruby</li>
  <li>dependencies - an array with jars and or the pom.xml file for loading dependencies. The jars should be located in a jars directory inside the zip archive, while the pom.xml should be at the root.</li>
  <li>task - a hash of attributes that defines the plugin at runtime.</li>
  <li>command - /:id/:method for the plugin</li>
  <li>inputs - a hash of values that are expected by the plugin, these will be accessed by the getField(s) methods.</li>
  <li>outputs - hash of values that will be set by the plugin and can be used in subsequent tasks.</li>
  <li>tool_name - category definition for the plugin</li>
</ul></div></div><div class="section"><h3>Directory and package structure<a name="Directory_and_package_structure"></a></h3><p>Maestro 4 expects plugins to be packaged as zip files. For java based plugins a pom.xml file should be at the root with a jars directory containing any included libs.</p><div class="section"><h4>example structure<a name="example_structure"></a></h4><p>maestro-irc-plugin.zip</p>
<ul>
  <li>pom.xml</li>
  <li>jars/maestro-irc-plugin-1.0-SNAPSHOT.jar</li>
</ul><p>This will take the dependencies inside the jar and load them as well as the maestro-irc-plugin-1.0-SNAPSHOT.jar that is created from the above example.</p></div><div class="section"><h4>Where to put the plugins<a name="Where_to_put_the_plugins"></a></h4><p>By default luCEE will look for plugins in <tt>~/.maestro/plugins</tt> but it can be overriden in <tt>maestro_lucee.json</tt> with</p>
<div class="source"><pre class="prettyprint">{
  &quot;lucee&quot;: {
    &quot;plugins&quot; : {
      &quot;install_path&quot; : &quot;/tmp/maestro-lucee&quot;
     }
  }
}
</pre></div><p>On startup luCEE will print a debug log with the resolved plugin location <tt>Deploying Plugins From ...</tt></p></div></div></div>
                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span16">Copyright &copy;                    2013
                        <a href="http://www.maestrodev.com">MaestroDev</a>.
            All Rights Reserved.      
            
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
